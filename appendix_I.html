<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Theophanis Tsandilas">
<meta name="author" content="Géry Casiez">

<title>The illusory promise of the Aligned Rank Transform</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="appendix_I_files/libs/clipboard/clipboard.min.js"></script>
<script src="appendix_I_files/libs/quarto-html/quarto.js"></script>
<script src="appendix_I_files/libs/quarto-html/popper.min.js"></script>
<script src="appendix_I_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="appendix_I_files/libs/quarto-html/anchor.min.js"></script>
<link href="appendix_I_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="appendix_I_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="appendix_I_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="appendix_I_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="appendix_I_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#comparing-type-i-error-rates-under-non-linear-models" id="toc-comparing-type-i-error-rates-under-non-linear-models" class="nav-link active" data-scroll-target="#comparing-type-i-error-rates-under-non-linear-models"><span class="header-section-number">1</span> Comparing Type I error rates under non-linear models</a>
  <ul class="collapse">
  <li><a href="#main-effects" id="toc-main-effects" class="nav-link" data-scroll-target="#main-effects">Main effects</a></li>
  <li><a href="#interactions" id="toc-interactions" class="nav-link" data-scroll-target="#interactions">Interactions</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The illusory promise of the Aligned Rank Transform</h1>
<p class="subtitle lead">Appendix I. Mathematical explanations and proofs</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Theophanis Tsandilas <a href="https://orcid.org/0000-0002-0158-228X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Université Paris-Saclay, CNRS, Inria, LISN
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <p class="author">Géry Casiez <a href="https://orcid.org/0000-0003-1905-815X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Univ. Lille, CNRS, Inria, Centrale Lille, UMR 9189 CRIStAL
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="comparing-type-i-error-rates-under-non-linear-models" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="comparing-type-i-error-rates-under-non-linear-models"><span class="header-section-number">1</span> Comparing Type I error rates under non-linear models</h2>
<p>Consider again the general relationship between the expected value of a response variable <span class="math inline">\(Y\)</span>, which may follow a non-normal distribution, and the predictors in an experimental design with two independent variables <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>:</p>
<p><span class="math display">\[
E(Y|x_1, x_2) = g^{-1}(a_0 + a_1 x_1 + a_2 x_2 + a_{12}x_1 x_2)
\]</span> where <span class="math inline">\(g^{-1}\)</span> is the inverse link function.</p>
<p>We show that, in the main scenarios considered in this article, the interpretation of effects is not affected by whether the null hypothesis is defined on the coefficient scale or on the response-mean scale. Our analysis follows related discussions in <span class="citation" data-cites="Ai:2003">Ai and Norton (<a href="#ref-Ai:2003" role="doc-biblioref">2003</a>)</span>, <span class="citation" data-cites="Greene:2010">Greene (<a href="#ref-Greene:2010" role="doc-biblioref">2010</a>)</span>, and <span class="citation" data-cites="McCabe:2022">McCabe et al. (<a href="#ref-McCabe:2022" role="doc-biblioref">2022</a>)</span>.</p>
<p>For clarity, let <span class="math display">\[
\eta(x_1, x_2) = a_0 + a_1 x_1 + a_2 x_2 + a_{12}x_1 x_2
\]</span> denote the linear predictor, and <span class="math display">\[
\mu(x_1, x_2) = E(Y|x_1, x_2) = g^{-1}(\eta(x_1, x_2))
\]</span> denote the expected value (or mean) as a function of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>.</p>
<section id="main-effects" class="level3">
<h3 class="anchored" data-anchor-id="main-effects">Main effects</h3>
<p>We first show that there is no ambiguity in the interpretation of main effects when <span class="math inline">\(a_{12}=0\)</span>.</p>
<p>Without loss of generality, assume that <span class="math inline">\(a_1 \neq 0\)</span> an examine the effect on the second factor <span class="math inline">\(x_2\)</span> when <span class="math inline">\(a_2 = 0\)</span>. In that case, <span class="math display">\[
\begin{aligned}
\eta(x_1, x_2) = a_0 + a_1 x_1, \qquad
\mu(x_1, x_2) = g^{-1}(a_0 + a_1 x_1)
\end{aligned}
\]</span> so <span class="math inline">\(\mu\)</span> is a function of <span class="math inline">\(x_1\)</span> only.</p>
<p>We consider two situations:</p>
<p><strong>(a) Continuous <span class="math inline">\(x_2\)</span>: effect defined by a partial derivative</strong></p>
<p>The effect of <span class="math inline">\(x_2\)</span> on the response can be defined as <span class="math inline">\(\frac{\partial \mu}{\partial x_2}\)</span>. Because the argument of <span class="math inline">\(g^{-1}\)</span> contains no <span class="math inline">\(x_2\)</span>: <span class="math display">\[\frac{\partial \mu(x_1, x_2)}{\partial x_2}  = \frac{\partial}{\partial x_2} g^{-1}(a_0 + a_1 x_1) = 0\]</span> Thus, <span class="math inline">\(x_2\)</span> has no effect on the mean response.</p>
<p><strong>(b) Categorical <span class="math inline">\(x_2\)</span>: effect defined by contrasts</strong></p>
<p>This is the setting relevant to our simulations. Let <span class="math inline">\(L_2\)</span> denote the levels of <span class="math inline">\(x_2\)</span>. For any two levels <span class="math inline">\(u, \nu \in L_2\)</span>, the contrast is: <span class="math display">\[\Delta_{u,\upsilon}\mu(x_1, x_2) = \mu(x_1, u) - \mu(x_1, \upsilon) = g^{-1}(a_0 + a_1 x_1) - g^{-1}(a_0 + a_1 x_1) = 0.\]</span></p>
<section id="conclusion-main-effects" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-main-effects">Conclusion (main effects)</h4>
<p>If <span class="math inline">\(a_{12} = 0\)</span> and <span class="math inline">\(a_2 = 0\)</span>, then <span class="math inline">\(x_2\)</span> has no effect on the mean of the responses. Thus, whether Type I error is defined in terms of the coefficient <span class="math inline">\(a_2\)</span> or in terms of the equality of observed means across levels of <span class="math inline">\(x_2\)</span> makes no difference.</p>
<p>This conclusion <strong>is not limited to means</strong>. If the distribution of <span class="math inline">\(Y | (x_1, x_2)\)</span> depends on <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span> only through the predictor <span class="math inline">\(\eta(x_1, x_2)\)</span> — that is, if scale or shape parameters do not depend on the factors — then no effect of <span class="math inline">\(x_2\)</span> can appear on the mean, the median, or any other quantile of the distribution whenever <span class="math inline">\(a_{12}=0\)</span> and <span class="math inline">\(a_2=0\)</span>.</p>
</section>
</section>
<section id="interactions" class="level3">
<h3 class="anchored" data-anchor-id="interactions">Interactions</h3>
<p>Similarly, we show that there is no ambiguity in the interpretation of interaction effects when either <span class="math inline">\(a_1 = 0\)</span> or <span class="math inline">\(a_2 =0\)</span>. Without loss of generality, assume <span class="math inline">\(a_2 = 0\)</span> and <span class="math inline">\(a_1 \neq 0\)</span>. When <span class="math inline">\(a_{12}=0\)</span>, <span class="math display">\[
\begin{aligned}
\eta(x_1, x_2) = a_0 + a_1 x_1, \qquad
\mu(x_1, x_2) = g^{-1}(a_0 + a_1 x_1)
\end{aligned}
\]</span></p>
<p>A common definition of interaction on the response scale <span class="citation" data-cites="Ai:2003">(<a href="#ref-Ai:2003" role="doc-biblioref">Ai and Norton 2003</a>)</span> is that the marginal effect of <span class="math inline">\(x_1\)</span> depends on <span class="math inline">\(x_2\)</span>. We examine two situations:</p>
<p><strong>(a) Continuous predictors: interaction defined by a cross-partial derivative.</strong></p>
<p>Assuming <span class="math inline">\(g^{-1}\)</span> is twice differentiable, an interaction is present if <span class="math inline">\(\frac{\partial^2 \mu}{\partial x_2 \partial x_1} \neq 0\)</span>.</p>
<p>We compute: <span class="math display">\[\frac{\partial \mu}{\partial x_1} = \dot{g}^{-1}(\eta) \cdot a_1\]</span></p>
<p>and</p>
<p><span class="math display">\[\frac{\partial^2 \mu}{\partial x_2 \partial x_1} = \ddot{g}^{-1}(\eta) \cdot \frac{\partial \eta}{\partial x_2} \cdot a_1\]</span></p>
<p>But for our settings (<span class="math inline">\(a_2=a_{12}=0\)</span>)</p>
<p><span class="math display">\[\frac{\partial \eta}{\partial x_2} = a_2 + a_{12}x_1 = 0\]</span></p>
<p>and therefore</p>
<p><span class="math display">\[\frac{\partial^2 \mu}{\partial x_2 \partial x_1} = 0\]</span></p>
<p>Thus the marginal effect of <span class="math inline">\(x_1\)</span> does not vary with <span class="math inline">\(x_2\)</span>, and there is no interaction.</p>
<p><strong>(b) Categorical predictors: interaction defined by double discrete differences</strong></p>
<p>Let <span class="math inline">\(L_1\)</span> and <span class="math inline">\(L_2\)</span> be the levels of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, respectively. The categorical analogue of a cross-partial derivative is the double difference:</p>
<p><span class="math display">\[\Delta_{u_1, \nu_1} \Delta_{u_2, \nu_2}\mu(x_1, x_2) = [\mu(u_1,u_2) - \mu(u_1, \nu_2)] - [\mu(\nu_1,u_2) - \mu(\nu_1, \nu_2)]\]</span></p>
<p>But when <span class="math inline">\(a_2 = a_{12} = 0\)</span>, <span class="math inline">\(\mu(u_1,u_2) = \mu(u_1,\nu_2)\)</span> and <span class="math inline">\(\mu(\nu_1,u_2) = \mu(\nu_1,\nu_2)\)</span>, so the double difference is always zero for any levels <span class="math inline">\(u_1, \nu_1 \in L_1\)</span> and <span class="math inline">\(u_2, \nu_2 \in L_2\)</span>.</p>
<section id="conclusion-interaction-effects" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-interaction-effects">Conclusion (interaction effects)</h4>
<p>If either <span class="math inline">\(a_1 = 0\)</span> or <span class="math inline">\(a_2 = 0\)</span> and <span class="math inline">\(a_{12} = 0\)</span>, then no interaction can be observed on the response scale. Thus Type I error definitions based on the coefficient <span class="math inline">\(a_{12}\)</span> or on observed interaction contrasts are equivalent in these settings.</p>
</section>
</section>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Ai:2003" class="csl-entry" role="listitem">
Ai, Chunrong, and Edward C. Norton. 2003. <span>“Interaction Terms in Logit and Probit Models.”</span> <em>Economics Letters</em> 80 (1): 123–129. https://doi.org/<a href="https://doi.org/10.1016/S0165-1765(03)00032-6">https://doi.org/10.1016/S0165-1765(03)00032-6</a>.
</div>
<div id="ref-Greene:2010" class="csl-entry" role="listitem">
Greene, William. 2010. <span>“<span class="nocase">Testing hypotheses about interaction terms in nonlinear models</span>.”</span> <em>Economics Letters</em> 107 (2): 291–296. <a href="https://ideas.repec.org/a/eee/ecolet/v107y2010i2p291-296.html">https://ideas.repec.org/a/eee/ecolet/v107y2010i2p291-296.html</a>.
</div>
<div id="ref-McCabe:2022" class="csl-entry" role="listitem">
McCabe, Connor J, Max A Halvorson, Kevin M King, Xiaolin Cao, and Dale S Kim. 2022. <span>“Interpreting Interaction Effects in Generalized Linear Models of Nonlinear Probabilities and Counts.”</span> <em>Multivariate Behavioral Research</em> 57 (2-3): 243–263. <a href="https://doi.org/10.1080/00273171.2020.1868966">https://doi.org/10.1080/00273171.2020.1868966</a>.
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>