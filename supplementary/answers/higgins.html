<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>higgins</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="higgins_files/libs/clipboard/clipboard.min.js"></script>
<script src="higgins_files/libs/quarto-html/quarto.js"></script>
<script src="higgins_files/libs/quarto-html/popper.min.js"></script>
<script src="higgins_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="higgins_files/libs/quarto-html/anchor.min.js"></script>
<link href="higgins_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="higgins_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="higgins_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="higgins_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="higgins_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#answer-to-the-response-of-prof.-james-higgins" id="toc-answer-to-the-response-of-prof.-james-higgins" class="nav-link active" data-scroll-target="#answer-to-the-response-of-prof.-james-higgins"><span class="header-section-number">1</span> Answer to the response of Prof.&nbsp;James Higgins</a>
  <ul class="collapse">
  <li><a href="#analysis-of-the-data-of-fig.-1-and-fig.-2" id="toc-analysis-of-the-data-of-fig.-1-and-fig.-2" class="nav-link" data-scroll-target="#analysis-of-the-data-of-fig.-1-and-fig.-2"><span class="header-section-number">1.1</span> Analysis of the data of Fig. 1 and Fig. 2</a></li>
  <li><a href="#simple-tests-that-demonstrate-arts-failure" id="toc-simple-tests-that-demonstrate-arts-failure" class="nav-link" data-scroll-target="#simple-tests-that-demonstrate-arts-failure"><span class="header-section-number">1.2</span> Simple tests that demonstrate ART’s failure</a></li>
  <li><a href="#validity-of-our-original-simulation-approach" id="toc-validity-of-our-original-simulation-approach" class="nav-link" data-scroll-target="#validity-of-our-original-simulation-approach"><span class="header-section-number">1.3</span> Validity of our original simulation approach</a></li>
  <li><a href="#other-comments" id="toc-other-comments" class="nav-link" data-scroll-target="#other-comments"><span class="header-section-number">1.4</span> Other comments</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">



<section id="answer-to-the-response-of-prof.-james-higgins" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Answer to the response of Prof.&nbsp;James Higgins</h1>
<p>We thank Prof.&nbsp;Higgins for his quick response. We explain why his argumentation is not correct and why our simulation approach does not introduce any spurious effects. We suggest some alternative, very simple simulation tests that the authors of ART can quickly conduct to confirm that ART completely fails.</p>
<p>The code, raw results, and figures supporting our responses are provided in the <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/tree/main/supplementary/rebuttals/higgins">supplementary materials</a>.</p>
<section id="analysis-of-the-data-of-fig.-1-and-fig.-2" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="analysis-of-the-data-of-fig.-1-and-fig.-2"><span class="header-section-number">1.1</span> Analysis of the data of Fig. 1 and Fig. 2</h2>
<p>Prof.&nbsp;Higgins uses ART to analyze the log-transformed values of Fig. 1 and Fig. 2 and reaches the following conclusion:</p>
<p><em>“If ART is applied to the logarithms, the p-values for ART show no inflation of Type I errors but instead are consistent with the model used to generate the data, namely, a log-normal model with only a main effect for level of difficulty and no interaction.”</em></p>
<p>We definitely agree. There is no surprise because the data are log-normal, so the LOG transformation makes the distributions normal. And as we have also demonstrated, ART behaves well under normal distributions (as long as variances are equal).</p>
<p>The problem is that ART <strong>is claimed</strong> to work correctly when applied directly on log-normal data, or data following other non-normal distributions. We refer Prof.&nbsp;Higgins to his own paper, coauthored with Elkin et al.&nbsp;(2021):</p>
<p><em>“We demonstrate these issues using our running example. Since we know the data in our running example is drawn from a lognormal distribution, we fit a linear mixed model (LMM) to log-transformed data as a baseline, and fit an ART model to the original (not log-transformed) data.”</em> (Page 757)</p>
<p>And this is how the authors demonstrate that the original version of ART fails to correctly infer contrasts. Later, the authors return to their running example to show that the results of their corrected ART-C method (applied to values that are not log-transformed) gives results that are consistent with the LOG method (see their Table 10).</p>
<p>So we used the very same approach of Elkin et al.&nbsp;(2021) to illustrate ART’s defects but identified instead a new set of more serious problems. Why is our interpretation “wrong” while theirs is correct?</p>
</section>
<section id="simple-tests-that-demonstrate-arts-failure" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="simple-tests-that-demonstrate-arts-failure"><span class="header-section-number">1.2</span> Simple tests that demonstrate ART’s failure</h2>
<p>Since Prof.&nbsp;Higgins believes to have found a flaw in our simulations, let us evaluate ART with a different but very simple type of simulation experiment, inspired by permutation tests.</p>
<p><strong>Data preparation.</strong> We take the data of our illustrative example but to simplify our analysis and presentation, we remove the <em>Participant</em> column, so we consider a scenario where all observations are independent. In addition, to ensure that we eliminate any spurious bias regarding the effect of <em>Technique</em> (e.g., due to hypothetical flaws of our original simulation approach), we remove the <em>Technique</em> column before we run our tests. <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/blob/main/supplementary/rebuttals/higgins/permutation-tests/example-data-1-simplified.csv">This is the dataset</a>, available for our readers to conduct these tests with their own code.</p>
<p><strong>Simulation method.</strong> We repeat the following two steps a large number times:</p>
<ul>
<li><p><em>Step 1</em>: We recreate the <em>Technique</em> column by randomly assigning the values at each level to the three techniques <em>A</em>, <em>B</em>, and <em>C</em>, where we make sure that the design is balanced, i.e., there are exactly 12 observations for each combination of difficulty level and technique.</p></li>
<li><p><em>Step 2</em>: We conduct and an analysis with all five methods (PAR, LOG, RNK, INT, and ART). For instance, we use the following formula for LOG: <code>aov(log(Time) ~ Difficulty*Technique, data=df)</code>. For all three effects (<em>Difficulty</em>, <em>Technique</em>, <em>Difficulty</em> x <em>Technique</em>), we assess whether the methods reject the null hypothesis (<span class="math inline">\(\alpha = .05\)</span>).</p></li>
</ul>
<p>We then calculate the rate of rejections of the null hypothesis over all the iterations. For <em>Difficulty</em>, we interpret the rate as power, since we know that there is a large effect across difficulty levels. In contrast, for <em>Technique</em> and its interaction with <em>Difficulty</em>, we interpret it as a Type I error rate, simply because the assignment of techniques to observations was random. We hope this interpretation is clear, as randomization is applied directly to the responses without any transformation.</p>
<p>For 5000 iterations, these are our results:</p>
<table class="table-sm small table">
<caption>% rates of positives (<span class="math inline">\(\alpha = .05\)</span>)</caption>
<thead>
<tr class="header">
<th></th>
<th style="text-align: right;">PAR</th>
<th style="text-align: right;">LOG</th>
<th style="text-align: right;">ART</th>
<th style="text-align: right;">RNK</th>
<th style="text-align: right;">INT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Difficulty</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
</tr>
<tr class="even">
<td>Technique</td>
<td style="text-align: right;">5.5</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">39.0</td>
<td style="text-align: right;">5.1</td>
<td style="text-align: right;">5.1</td>
</tr>
<tr class="odd">
<td>Difficulty <span class="math inline">\(\times\)</span> Technique</td>
<td style="text-align: right;">10.7</td>
<td style="text-align: right;">5.1</td>
<td style="text-align: right;">22.8</td>
<td style="text-align: right;">5.3</td>
<td style="text-align: right;">5.5</td>
</tr>
</tbody>
</table>
<p>ART detects a main effect of <em>Technique</em> with an error rate of 39% and an interaction effect with an error rate of 22.8%! We observe that PAR also struggles with the interaction but to a lesser degree.</p>
<p>But let us observe a more problematic situation, where we add an additional spurious variable (<em>Birthseason</em>) to represent the season of participants’ birth (1 = spring, 2 = summer, 3 = autumn, 4 = winter). We just add a new column to the data, where each row takes a random value in this range. The design is partly imbalanced now, so it is not a surprise that ART fails even more seriously:</p>
<table class="table-sm small table">
<caption>% rates of positives (<span class="math inline">\(\alpha = .05\)</span>)</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th style="text-align: right;">PAR</th>
<th style="text-align: right;">LOG</th>
<th style="text-align: right;">ART</th>
<th style="text-align: right;">RNK</th>
<th style="text-align: right;">INT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Difficulty</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
</tr>
<tr class="even">
<td>Technique</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">42.0</td>
<td style="text-align: right;">5.1</td>
<td style="text-align: right;">4.7</td>
</tr>
<tr class="odd">
<td>Birthseason</td>
<td style="text-align: right;">6.4</td>
<td style="text-align: right;">5.5</td>
<td style="text-align: right;">72.1</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">5.1</td>
</tr>
<tr class="even">
<td>Difficulty <span class="math inline">\(\times\)</span> Technique</td>
<td style="text-align: right;">10.1</td>
<td style="text-align: right;">5.5</td>
<td style="text-align: right;">25.6</td>
<td style="text-align: right;">4.9</td>
<td style="text-align: right;">5.6</td>
</tr>
<tr class="odd">
<td>Difficulty <span class="math inline">\(\times\)</span> Birthseason</td>
<td style="text-align: right;">10.6</td>
<td style="text-align: right;">5.1</td>
<td style="text-align: right;">28.4</td>
<td style="text-align: right;">4.9</td>
<td style="text-align: right;">4.9</td>
</tr>
<tr class="even">
<td>Technique <span class="math inline">\(\times\)</span> Birthseason</td>
<td style="text-align: right;">7.8</td>
<td style="text-align: right;">4.2</td>
<td style="text-align: right;">87.4</td>
<td style="text-align: right;">4.4</td>
<td style="text-align: right;">4.5</td>
</tr>
<tr class="odd">
<td>Difficulty <span class="math inline">\(\times\)</span> Technique <span class="math inline">\(\times\)</span> Birthseason</td>
<td style="text-align: right;">15.4</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">32.2</td>
<td style="text-align: right;">5.5</td>
<td style="text-align: right;">5.3</td>
</tr>
</tbody>
</table>
<p>ART’s error rates are enormous! The method can easily lead to extremely fallacious conclusions. The authors of ART may complain here that the ARTool issues a warning when imbalances in the design arise. We agree, but such imbalances occur very frequently in real studies, and we have observed that many HCI authors completely ignore this warning. Prof.&nbsp;Higgins may notice that RNK and INT behave very well in such situations, and we can show that they remain precise even if we consider a lower significance level <span class="math inline">\(\alpha = .01\)</span>.</p>
<p>The failures of ART are of course not specific to this dataset. For example, if we use <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/blob/main/supplementary/rebuttals/higgins/permutation-tests/example-data-2.csv">the dataset</a> we analyzed in our previous answer (sampled from homoscedastic log-normal populations), we find the following results for perfectly balanced designs:</p>
<table class="table-sm small table">
<caption>% rates of positives (<span class="math inline">\(\alpha = .05\)</span>)</caption>
<thead>
<tr class="header">
<th></th>
<th style="text-align: right;">PAR</th>
<th style="text-align: right;">LOG</th>
<th style="text-align: right;">ART</th>
<th style="text-align: right;">RNK</th>
<th style="text-align: right;">INT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Difficulty</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
<td style="text-align: right;">100.0</td>
</tr>
<tr class="even">
<td>Technique</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: right;">4.9</td>
<td style="text-align: right;">13.4</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">4.7</td>
</tr>
<tr class="odd">
<td>Difficulty <span class="math inline">\(\times\)</span> Technique</td>
<td style="text-align: right;">2.8</td>
<td style="text-align: right;">6.4</td>
<td style="text-align: right;">10.7</td>
<td style="text-align: right;">5.1</td>
<td style="text-align: right;">5.5</td>
</tr>
</tbody>
</table>
<p>The conclusions are clear. ART’s failure is not due to any wrong interpretations. As we explained in our previous answer, ART’s alignment method is based on the assumption that the shape of the distribution (log-normal here) is identical across all factor levels. This is not the case in these datasets where distribution shapes change across difficulty levels, causing the method to break down.</p>
<p>Our R code for these tests is available <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/tree/main/supplementary/rebuttals/higgins/permutation-tests">here</a>.</p>
</section>
<section id="validity-of-our-original-simulation-approach" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="validity-of-our-original-simulation-approach"><span class="header-section-number">1.3</span> Validity of our original simulation approach</h2>
<p>Prof.&nbsp;Higgins argues that our simulation method produces an effect on factor 2 even if a2 is zero, and despite the fact that the interaction term a12 is also zero. This is incorrect. Our reviewer does not provide any logical reasoning to support his argument.</p>
<p>Consider the following model: <span class="math inline">\(f(Y) = \alpha_1 x_1 + \epsilon\)</span></p>
<p>where <span class="math inline">\(\epsilon\)</span> is a random error and <span class="math inline">\(f\)</span> is a monotonic function. Prof.&nbsp;Higgins argues that it is possible that <span class="math inline">\(Y = f^{-1}\)</span> depends on <span class="math inline">\(x_2\)</span> despite the fact that the variable is absent in the above equation. By extension, one can argue that <span class="math inline">\(Y\)</span> will also depend on any spurious variable that we may decide to include: <span class="math inline">\(x_3, x_4, x_5, ...\)</span> But unless there is a serious bug in our code, how could this be possible?</p>
<p>To reassure our readers that there is no such bug, we demonstrate how exactly our simulation generates data distributions, focusing again on log-normal data. We concentrate on a 4x3 within-subjects design, where <span class="math inline">\(a_1 = 4\)</span>, <span class="math inline">\(a_2=0\)</span>, and <span class="math inline">\(a_{12}=0\)</span>. We then use our experimental code to:</p>
<ol type="1">
<li><p>Draw a very large sample <code>n=100000</code> using our model (Equation 2). The left column of the figure below shows the produced normal distributions at each combination of the two factors. The curves in the figures are kernel density estimates produced using R’s <code>density</code> function. We also show the mean and standard deviation estimates of these distributions based on our sample. We clearly see that the distributions are identical across all levels of the second factor <span class="math inline">\(x_2\)</span> (tiny differences are due to sampling error).</p></li>
<li><p>Transform the sample based on the approach we describe in the paper. For our <code>norm2lnorm</code> function, we use the parameters <code>meanlog = 0</code> and <code>sdlog = 1</code>. The right column of the figure shows the estimated curves of the transformed distributions. We show again the estimated parameters of the distributions, knowing that they are log-normal. We clearly see again that the distributions are identical across all levels of the second factor <span class="math inline">\(x_2\)</span> — its main effect remains null and there is no interaction.</p></li>
</ol>
<p><img src="https://github.com/journalovi/2024-tsandilas-ranktransforms/blob/main/supplementary/rebuttals/higgins/figures/simulation-effects.png" class="img-fluid"></p>
<p>We can run the same test with other <span class="math inline">\(a_1\)</span> values and other distributions. Conclusions will not change. Our simulation method does not introduce any spurious effects. <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/tree/main/supplementary/rebuttals/higgins/simulation-method">We provide our code</a> that generates these plots, so that our readers can conduct their own tests.</p>
</section>
<section id="other-comments" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="other-comments"><span class="header-section-number">1.4</span> Other comments</h2>
<p>Finally, we reply to the additional comments of our reviewer:</p>
<ul>
<li><p><em>“I believe the authors incorrectly compare the p-values for ART vs.&nbsp;PAR for Fig. 1 data.”</em><br>
Please, see our analyses above. The comparison is both correct and fair.</p></li>
<li><p><em>“The use of RNK and INT for factorial data is questionable. I would never recommend these procedures for multi-factor data.”</em><br>
We aimed to provide balanced recommendations for these methods, explaining that they too can fail in certain scenarios. Our article actually recommends that <em>“there are valid reasons to prioritize parametric methods and reserve rank transformations as last-resort solutions.”</em> However, RNK and INT are significantly superior to ART in most respects, and unlike ART, we believe they remain useful tools if they are appropriately used.</p></li>
<li><p><em>“The authors’ strong condemnation of ART is not supported by their own literature review (in particular the results obtained by Elkin).”</em><br>
Please read our <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/issues/2#issuecomment-2483020115">previous response</a> carefully. There is no contradiction between our results and those of Elkin et al.&nbsp;(2021). Their experiments did not examine how a main effect on one factor could lead ART to falsely detect effects on other factors. Moreover, their evaluations were limited to continuous distributions and did not include comparisons of ART with other rank-based methods. Prof.&nbsp;Higgins also overlooks the condemning findings of Lüpsen (2017, 2018), which Elkin et al.&nbsp;(2021) failed to cite.</p></li>
<li><p><em>“The authors’ model (2) is not the ANOVA model upon which ART is based. This creates more misleading apples-to-oranges comparisons.”</em><br>
This is a standard mixed-effects model (e.g., see DeBruine and Barr, 2021), which can describe the full set of experimental designs that we address in this paper: between-subjects, within-subjects, and mixed designs that combine a between- and a within-subjects factor. We use the <a href="https://debruine.github.io/faux">faux simulation package</a> to generate data with this model, and our use of the <code>art()</code> function (ARTool R package) is fully consistent with the model parameters. For example, if the random intercept term <span class="math inline">\(s_k\)</span> is relevant, we include a <code>(1|S)</code> term in the formula, and apply the same approach to the other methods when calling the <em>lmer</em> function. This approach aligns perfectly with the analysis by Elkin et al.&nbsp;(2021). Can our reviewer clarify his concerns? What aspects of our model are misleading?</p></li>
<li><p><em>“The rebuttal to my original comments suggests that interaction can be defined in more than one way. However, when formulated in terms of means of treatments, there is no ambiguity. The authors might want to define interaction some other way, but let’s be certain that the parameters that are being tested by the various methods are for the same parameters.”</em><br>
We explained that interaction interpretation issues arise ONLY when all parameters of the interacting factors (e.g., <span class="math inline">\(a_1\)</span> and <span class="math inline">\(a_2\)</span> for a two-factor design) are non-zero. As we mentioned in our <a href="https://github.com/journalovi/2024-tsandilas-ranktransforms/issues/2#issuecomment-2507452242">earlier message</a>, we will create a separate results section specifically for cases with interpretation issues to prevent further confusion.</p></li>
<li><p><em>“The authors proposed revisions suggest that ART is very limited in its applicability which is not true. Every one of the methods that the authors propose to use are ANOVA models. They only differ in the data to which they are applied. In every case, ART may be correctly applied provided it is applied to the same data that their methods are applied to.”</em><br>
The key distinction of ART lies in its alignment method. Our results demonstrate that this alignment method fails when the data deviate from the specific model described by Prof.&nbsp;Higgins in his previous response. Please check the strict assumptions of Mansouri and Chang (1995) in their proof. Is Prof.&nbsp;Higgins aware of any theoretical work demonstrating that this same alignment method remains valid for generalized linear models, which involve nonlinear functions, discrete data, or ordinal scales? Are there any positive findings supporting its robustness in such cases? Given our results, how can Prof.&nbsp;Higgins remain so confident in its applicability?</p></li>
</ul>
<p>As a final comment on our reviewer’s concluding remarks that ART is <em>“just a rank-based extension of ANOVA,”</em> we present the following plots, which visualize the relationship between the original responses in our example from Fig. 1 and their rank transformations using RNK and ART:</p>
<p><img src="ART-deformation.png" class="img-fluid"></p>
<p>The plots show ART’s rankings with respect to both <em>Difficulty</em> (center) and <em>Technique</em> (right). Notice how radically ART transforms the data prior to applying ANOVA. Unfortunately, such complex transformations introduce numerous opportunities for errors and distortions.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>