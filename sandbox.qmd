---
title: "The illusory promise of the Aligned Rank Transform"
subtitle: "A systematic study of rank transformations"
author: 
  - name: Theophanis Tsandilas
    orcid: 0000-0002-0158-228X
    email: theophanis.tsandilas@inria.fr
    affiliations:
      - name: Université Paris-Saclay, CNRS, Inria, LISN
        country: France
  - name: Géry Casiez
    orcid: 0000-0003-1905-815X
    email: gery.casiezuniv-lille.fr
    affiliations:
      - name: Univ. Lille, CNRS, Inria, Centrale Lille, UMR 9189 CRIStAL
        country: France
bibliography: bibliography.bib
csl: canadian-journal-of-philosophy.csl

tbl-cap-location: top
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Useful libraries
library(crosstalk)
library(kableExtra)
library(gridExtra)
library(lmerTest)
library(tidyverse)
library(plotly)
```

```{=html}
<style>
.math.inline .MathJax  {
  font-size: 105% !important;
}
</style>
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)

source("utils-data-reading.R")
source("utils-plotlying.R")
```

```{=html}
<style>
.math.inline .MathJax  {
  font-size: 105% !important;
}
</style>
```

We present complementary results and new experiments that investigate additional scenarios. We also compare INT and RNK with other nonparametric methods. Unless explicitly mentioned in each section, we follow the experimental methodology presented in the main article. At the end of each section, we summarize our conclusions.

## Generalizations of nonparametric tests {#generalized}

Finally, we evaluate the generalizations of nonparametric tests recommended by Lüpsen [-@luepsen:2018; -@luepsen:2023] as implemented in his *np.anova* function [@luepsen_R]. Specifically, we examine the generalization of the van der Waerden test (VDW) and the generalization of the Kruskal-Wallis and Friedman tests (KWF). 

These implementations require random slopes to be included in the error term of the model. Concretely, we use ``Error(Subject/(X1*X2))`` for the two-factor within-participants design and ``Error(Subject/X2)`` for the mixed design. We use the same modeling approach for all other methods to ensure comparability.

**Type I error rates: Main effects**. @fig-vdWaerden-designs-main shows the Type I error rates for the main effect of $X_2$. While all methods perform well under the within-subjects and mixed designs, the error rates of VDW and KWF drop sharply as the effect of $X_1$ increases under the between-subjects design. As shown below, this behavior reflects a severe loss of power for these two methods in these conditions.

::: {#fig-vdWaerden-designs-main}
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
prefix <- "Type_I_vdWaerden"
alpha = 0.05

distributions = c("norm", "lnorm", "exp", "poisson", "binom", "likert")
dnames = c("Normal", "Log-normal", "Exponential", "Poisson", "Binomial", "Ordinal (5 levels)")
methods = c("RNK", "INT", "VDW", "KWF")
palette = c("#E69F00", "#009E73", "#FF70AB", "#888888")

df <- read_data(prefix, alpha, effectType = 1, distributions, methods = methods)
df <- reshape_by_design(df, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))

plotly_error_by_design_2(df, xlab = "magnitude of main effect", var = "rateX2", xvar = "effectX1", max = 8.1, nticks=8, cbPalette = palette)
```
Type I error rates ($\alpha = .05$) for the **main effect of $X_2$** as a function of the magnitude $a_1$ of the main effect of $X_1$ ($n = 20$)
:::

**Type I error rates: Interactions**. @fig-vdWaerden-designs-interaction-1 presents the Type I error rates for the interaction in the presence of a single main effect. Again, the error rates of VDW and KWF decrease rapidly, now in both the between-subjects and mixed designs. We also observe inflation of the error rates of RNK and INT for large effects under discrete distributions.

::: {#fig-vdWaerden-designs-interaction-1}
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
df <- read_data(prefix, alpha, effectType = 2, distributions, methods = methods)
df <- reshape_by_design(df, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))

plotly_error_by_design_2(df, xlab = "magnitude of main effect", var = "rateX1X2", xvar = "effectX2", max = 8.1, nticks=8, cbPalette = palette)
```
Type I error rates ($\alpha = .05$) for the **interaction** $X_1 \times X_2$ as a function of the magnitude $a_2$ of the main effect of $X_2$ ($n = 20$) 
:::

@fig-vdWaerden-designs-interaction-2 shows the results when both $a_1$ and $a_2$ increase. In these settings, all four methods struggle as effect magnitudes grow, though their behavior varies across distributions and experimental designs. Depending on the configuration, the methods either inflate positive rates or deflate them below nominal levels. INT appears to be the most stable method for continuous distributions, but its positive rates increase more rapidly under discrete distributions.    

::: {#fig-vdWaerden-designs-interaction-2}
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
df <- read_data(prefix, alpha, effectType = 0, distributions, methods = methods)
df <- reshape_by_design(df, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_error_by_design_2(df, xlab = "magnitude of main effects", ytitle = 'Positives (%)', var = "rateX1X2", xvar = "effectX1", max = 104, nticks=8, cbPalette = palette)
```
Positive rates ($\alpha = .05$) for the **interaction** $X_1 \times X_2$ as a function of the magnitudes $a_1 = a_2$ of the main effects of $X_1$ and $X_2$ ($n = 20$). *Note: These values correspond to Type I error rates under the null hypothesis $a_{12} = 0$; alternative definitions of the null hypothesis may lead to different results.* 
:::

**Power: Main effects**. @fig-vdWaerden-power-main-1 presents power results for detecting the main effect of $X_1$. Although differences are generally small, INT emerges as the most powerful method in most configurations. In several cases (e.g., log-normal distributions in the within-subjects and mixed designs), the power of VDW and KWF lags behind that of RNK and INT.

::: {#fig-vdWaerden-power-main-1}
<div id="plot-power-vd.1">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
prefix <- "Power_vdWaerden"
distributions = c("norm", "lnorm", "exp", "poisson", "binom", "likert")
dnames = c("Normal", "Log-normal", "Exponential", "Poisson", "Binomial", "Ordinal (5 levels)")

data <- read_data(prefix, alpha = .05, effectType = 3, distributions, methods = methods)
df <- reshape_by_design(data, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_error_by_design_2(df, xlab = "magnitude of main effect", var = "rateX1", xvar = "effectX1", max = 104,  ytitle = 'Power (%)', cbPalette = palette)
```
</div>

<div id="plot-power-vd.2">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
df <- data %>% arrange(design,family,effectX1,rateX1)  %>% group_by(design,family,effectX1) %>% mutate(rank = rank(rateX1))
df <- as.data.frame(df) %>% reshape_by_design(dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_power_by_design(df, xlab = "magnitude of main effect", var = "rank", hovervar = "rateX1", xvar = "effectX1", max = 4.2, ytitle = 'Power - ranking', cbPalette = palette)
```
</div> <style> .hidden { display: none; } </style> <script> document.addEventListener("DOMContentLoaded", function() { document.getElementById("plot-power-vd.2").classList.add("hidden"); }); </script>

<button id="btnvd1" style="background-color: #f0f0f0; border: 1px solid #ccc; color: #333; font-size: 0.9em;
    padding: 4px 10px; border-radius: 6px; cursor: pointer; float: right;"
  onclick="const plot = document.getElementById('plot-power-vd.1');
  plot.classList.toggle('hidden');
  document.getElementById('plot-power-vd.2').classList.toggle('hidden');
  btnvd1.innerText = plot.classList.contains('hidden') ? 'show percent' : 'show ranking';
">
  show ranking
</button>

Power ($\alpha = .05$) for detecting the **main effect of $X_1$** as a function of the magnitude of effect $a_1$ ($n=20$).
:::

We also report power results for the second factor $X_2$, which confirm that VDW and KWF offer no clear advantage, particularly when compared with INT.

::: {#fig-vdWaerden-power-main-2}
<div id="plot-power-vd.3">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
prefix <- "Power_vdWaerden"
distributions = c("norm", "lnorm", "exp", "poisson", "binom", "likert")
dnames = c("Normal", "Log-normal", "Exponential", "Poisson", "Binomial", "Ordinal (5 levels)")

data <- read_data(prefix, alpha = .05, effectType = 4, distributions, methods = methods)
df <- reshape_by_design(data, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_error_by_design_2(df, xlab = "magnitude of main effect", var = "rateX2", xvar = "effectX2", max = 104,  ytitle = 'Power (%)', cbPalette = palette)
```
</div>

<div id="plot-power-vd.4">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
df <- data %>% arrange(design,family,effectX2,rateX2)  %>% group_by(design,family,effectX2) %>% mutate(rank = rank(rateX2))
df <- as.data.frame(df) %>% reshape_by_design(dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_power_by_design(df, xlab = "magnitude of main effect", var = "rank", hovervar = "rateX2", xvar = "effectX2", max = 4.2, ytitle = 'Power - ranking', cbPalette = palette)
```
</div> <style> .hidden { display: none; } </style> <script> document.addEventListener("DOMContentLoaded", function() { document.getElementById("plot-power-vd.4").classList.add("hidden"); }); </script>

<button id="btnvd2" style="background-color: #f0f0f0; border: 1px solid #ccc; color: #333; font-size: 0.9em;
    padding: 4px 10px; border-radius: 6px; cursor: pointer; float: right;"
  onclick="const plot = document.getElementById('plot-power-vd.3');
  plot.classList.toggle('hidden');
  document.getElementById('plot-power-vd.4').classList.toggle('hidden');
  btnvd2.innerText = plot.classList.contains('hidden') ? 'show percent' : 'show ranking';
">
  show ranking
</button>

Power ($\alpha = .05$) for detecting the **main effect of $X_2$** as a function of the magnitude of effect $a_2$ ($n=20$).
:::

**Power: Interactions**. We also report power results for detecting interaction effects in @fig-vdWaerden-power-interaction. These results further confirm the overall advantage of INT across all designs.

::: {#fig-vdWaerden-power-interaction}
<div id="plot-power-vd.5">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
prefix <- "Power_vdWaerden"
distributions = c("norm", "lnorm", "exp", "poisson", "binom", "likert")
dnames = c("Normal", "Log-normal", "Exponential", "Poisson", "Binomial", "Ordinal (5 levels)")

data <- read_data(prefix, alpha = .05, effectType = 5, distributions, methods = methods)
df <- reshape_by_design(data, dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_error_by_design_2(df, xlab = "magnitude of main effect", var = "rateX1X2", xvar = "effectX1X2", max = 104,  ytitle = 'Power (%)', cbPalette = palette)
```
</div>

<div id="plot-power-vd.6">
```{r, echo=FALSE, fig.height=3.3, fig.width = 9, warning=FALSE}
df <- data %>% arrange(design,family,effectX1X2,rateX1X2)  %>% group_by(design,family,effectX1X2) %>% mutate(rank = rank(rateX1X2))
df <- as.data.frame(df) %>% reshape_by_design(dnames, effectvars = c("effectX1","effectX2","effectX1X2"))
plotly_power_by_design(df, xlab = "magnitude of main effect", var = "rank", hovervar = "rateX1X2", xvar = "effectX1X2", max = 4.2, ytitle = 'Power - ranking', cbPalette = palette)
```
</div> <style> .hidden { display: none; } </style> <script> document.addEventListener("DOMContentLoaded", function() { document.getElementById("plot-power-vd.6").classList.add("hidden"); }); </script>

<button id="btnvd3" style="background-color: #f0f0f0; border: 1px solid #ccc; color: #333; font-size: 0.9em;
    padding: 4px 10px; border-radius: 6px; cursor: pointer; float: right;"
  onclick="const plot = document.getElementById('plot-power-vd.5');
  plot.classList.toggle('hidden');
  document.getElementById('plot-power-vd.6').classList.toggle('hidden');
  btnvd3.innerText = plot.classList.contains('hidden') ? 'show percent' : 'show ranking';
">
  show ranking
</button>

Power ($\alpha = .05$) for detecting the **interaction effect $X_1 \times X_2$** as a function of the magnitude of effect $a_{12}$ ($n=20$).
:::

